<svg width="1000" height="800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f0f9ff;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#e0f2fe;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="cfGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#dbeafe;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#93c5fd;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="sqlGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#fef3c7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#fbbf24;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="gcsGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#dcfce7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#4ade80;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="bqGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#fce7f3;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f472b6;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1000" height="800" fill="url(#bgGradient)"/>
  
  <!-- Title -->
  <text x="500" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#1e40af">
    SQL Server to BigQuery データ同期システム フロー図
  </text>

  <!-- Trigger Section -->
  <rect x="50" y="70" width="150" height="60" rx="10" fill="#e5e7eb" stroke="#6b7280" stroke-width="2" filter="url(#shadow)"/>
  <text x="125" y="90" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#374151">トリガー</text>
  <text x="125" y="105" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#6b7280">HTTP Request</text>
  <text x="125" y="118" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#6b7280">Cloud Scheduler</text>

  <!-- Cloud Function -->
  <rect x="300" y="70" width="200" height="120" rx="15" fill="url(#cfGradient)" stroke="#3b82f6" stroke-width="3" filter="url(#shadow)"/>
  <text x="400" y="95" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1e40af">Cloud Function</text>
  <text x="400" y="115" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">DataSyncManager</text>
  <text x="400" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#3730a3">• 環境変数読み込み</text>
  <text x="400" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#3730a3">• テーブル設定解析</text>
  <text x="400" y="160" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#3730a3">• 同期処理制御</text>
  <text x="400" y="175" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#3730a3">• エラーハンドリング</text>

  <!-- SQL Server -->
  <rect x="50" y="250" width="180" height="100" rx="10" fill="url(#sqlGradient)" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="140" y="275" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#92400e">SQL Server</text>
  <text x="140" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">SQLAlchemy + pyodbc</text>
  <text x="140" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">• テーブル1 (timestamp列あり)</text>
  <text x="140" y="325" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">• テーブル2 (timestamp列なし)</text>
  <text x="140" y="340" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">• テーブル3 (timestamp列あり)</text>

  <!-- BigQuery Metadata -->
  <rect x="600" y="250" width="160" height="80" rx="10" fill="url(#bqGradient)" stroke="#ec4899" stroke-width="2" filter="url(#shadow)"/>
  <text x="680" y="275" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#be185d">BigQuery</text>
  <text x="680" y="290" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#be185d">sync_metadata</text>
  <text x="680" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#be185d">前回同期時刻管理</text>
  <text x="680" y="320" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#be185d">同期状態追跡</text>

  <!-- Data Processing Section -->
  <rect x="250" y="250" width="280" height="100" rx="10" fill="#f3f4f6" stroke="#9ca3af" stroke-width="2" filter="url(#shadow)"/>
  <text x="390" y="275" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#374151">データ処理ロジック</text>
  
  <!-- Conditional Logic -->
  <g>
    <polygon points="280,290 320,310 280,330 240,310" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
    <text x="280" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#92400e">timestamp列?</text>
  </g>
  
  <rect x="340" y="285" width="80" height="25" rx="5" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
  <text x="380" y="300" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#166534">差分抽出</text>
  
  <rect x="430" y="285" width="80" height="25" rx="5" fill="#fee2e2" stroke="#dc2626" stroke-width="1"/>
  <text x="470" y="300" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#991b1b">全件抽出</text>
  
  <rect x="280" y="320" width="200" height="25" rx="5" fill="#e0f2fe" stroke="#0891b2" stroke-width="1"/>
  <text x="380" y="335" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#0e7490">pandas DataFrame変換</text>

  <!-- Cloud Storage -->
  <rect x="50" y="450" width="200" height="100" rx="10" fill="url(#gcsGradient)" stroke="#16a34a" stroke-width="2" filter="url(#shadow)"/>
  <text x="150" y="475" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#166534">Cloud Storage</text>
  <text x="150" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">CSV ファイル保存</text>
  <text x="150" y="510" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">tableName_YYYYMMDD_HHMMSS.csv</text>
  <text x="150" y="525" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">JST タイムスタンプ付き</text>
  <text x="150" y="540" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">UTF-8 エンコード</text>

  <!-- Final BigQuery -->
  <rect x="400" y="450" width="200" height="100" rx="10" fill="url(#bqGradient)" stroke="#ec4899" stroke-width="2" filter="url(#shadow)"/>
  <text x="500" y="475" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#be185d">BigQuery</text>
  <text x="500" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#be185d">メタデータ更新</text>
  <text x="500" y="510" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#be185d">最大timestamp記録</text>
  <text x="500" y="525" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#be185d">同期完了時刻保存</text>

  <!-- Error Handling -->
  <rect x="700" y="450" width="150" height="100" rx="10" fill="#fee2e2" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="775" y="475" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#991b1b">エラー処理</text>
  <text x="775" y="495" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#991b1b">ログ出力</text>
  <text x="775" y="510" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#991b1b">リソース解放</text>
  <text x="775" y="525" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#991b1b">ステータス返却</text>

  <!-- Monitoring -->
  <rect x="700" y="320" width="150" height="80" rx="10" fill="#f0fdf4" stroke="#22c55e" stroke-width="2" filter="url(#shadow)"/>
  <text x="775" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#166534">監視・ログ</text>
  <text x="775" y="365" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">Cloud Logging</text>
  <text x="775" y="380" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">Cloud Monitoring</text>
  <text x="775" y="395" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#166534">アラート通知</text>

  <!-- Arrows -->
  <!-- Trigger to Cloud Function -->
  <path d="M 200 100 Q 250 100 300 130" stroke="#4f46e5" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Cloud Function to SQL Server -->
  <path d="M 300 150 Q 250 200 140 250" stroke="#4f46e5" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Cloud Function to BigQuery Metadata -->
  <path d="M 500 150 Q 550 200 680 250" stroke="#4f46e5" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Cloud Function to Data Processing -->
  <path d="M 400 190 L 400 250" stroke="#4f46e5" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Data Processing to Cloud Storage -->
  <path d="M 300 350 Q 250 400 150 450" stroke="#4f46e5" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Data Processing to BigQuery Final -->
  <path d="M 450 350 Q 475 400 500 450" stroke="#4f46e5" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Cloud Function to Monitoring -->
  <path d="M 500 130 Q 600 200 700 360" stroke="#10b981" stroke-width="1" fill="none" stroke-dasharray="5,5"/>
  
  <!-- Cloud Function to Error Handling -->
  <path d="M 500 170 Q 600 300 700 500" stroke="#dc2626" stroke-width="1" fill="none" stroke-dasharray="5,5"/>

  <!-- Decision Flow -->
  <path d="M 320 310 L 340 300" stroke="#f59e0b" stroke-width="1" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 320 310 L 430 300" stroke="#f59e0b" stroke-width="1" fill="none" marker-end="url(#arrowhead)"/>

  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4f46e5"/>
    </marker>
  </defs>

  <!-- Legend -->
  <rect x="50" y="650" width="900" height="120" rx="10" fill="#ffffff" stroke="#d1d5db" stroke-width="1" opacity="0.9"/>
  <text x="500" y="675" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#374151">処理フロー説明</text>
  
  <text x="70" y="700" font-family="Arial, sans-serif" font-size="11" fill="#374151">1. HTTP/Scheduler → Cloud Function トリガー</text>
  <text x="70" y="715" font-family="Arial, sans-serif" font-size="11" fill="#374151">2. 環境変数から同期テーブル設定を読み込み</text>
  <text x="70" y="730" font-family="Arial, sans-serif" font-size="11" fill="#374151">3. BigQueryから前回同期時刻を取得（timestamp列ありの場合）</text>
  <text x="70" y="745" font-family="Arial, sans-serif" font-size="11" fill="#374151">4. SQL Serverから差分/全件データを抽出</text>
  
  <text x="500" y="700" font-family="Arial, sans-serif" font-size="11" fill="#374151">5. pandasでCSV形式に変換</text>
  <text x="500" y="715" font-family="Arial, sans-serif" font-size="11" fill="#374151">6. JSTタイムスタンプ付きでGCSに保存</text>
  <text x="500" y="730" font-family="Arial, sans-serif" font-size="11" fill="#374151">7. 最大timestampをBigQueryメタデータに記録</text>
  <text x="500" y="745" font-family="Arial, sans-serif" font-size="11" fill="#374151">8. ログ出力とエラーハンドリング</text>